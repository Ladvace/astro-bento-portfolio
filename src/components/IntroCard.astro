---
import Card from "./Card/index.astro";
import Button from "./Button.astro";
import { LINKS } from "../lib/constants";
import { Icon } from "astro-icon/components";
import Tooltip from "./Tooltip/index";
import { Image } from "astro:assets";
import MemojiAvatarDefault from "../assets/me.webp";
import MemojiAvatarBlue from "../assets/me-blue.webp";
import MemojiAvatarGreen from "../assets/me-green.webp";
import MemojiAvatarPurple from "../assets/me-purple.webp";
import MemojiAvatarYellow from "../assets/me-yellow.webp";
---

<Card colSpan="md:col-span-3" rowSpan="md:row-span-4">
  <div class="flex w-full h-full">
    <div class="flex flex-col justify-between md:max-h-[300px] gap-4">
      <div class="flex flex-col h-full">
        <h6 class="text-sm font-light m-0 text-darkslate-300">welcome</h6>

        <p class="sr-only">
          Hi, I'm Gianmarco Cavallo, a software developer with strong focus on
          the user experience, animations, micro interactions and SEO. Feel
          free to reach out to me if you have any project in mind, want to
          collaborate, or just want to say hello.
        </p>
        <p aria-hidden="true" class="m-0 font-light text-md">
          <span>
            Hi, I'm <b class="font-bold">Gianmarco Cavallo</b>, a software
            developer with strong focus on the user experience, animations,
            micro interactions and SEO.
          </span>
          <br />
          <span class="block mt-2">
            Feel free to reach out to me if you have any project in mind, want
            to collaborate, or just want to say hello.
          </span>
        </p>
      </div>
      <div class="flex flex-col lg:flex-row gap-2 lg:gap-4">
        <div class="flex gap-2 lg:gap-4">
          <a href={LINKS.github} aria-label="github profile" target="_blank">
            <Button aria-label="github profile">
              <Icon name="ri:github-fill" />
              <span class="sr-only" data-umami-event="github button"
                >GitHub Profile</span
              >
            </Button>
          </a>
          <a
            href={LINKS.linkedin}
            aria-label="linkedin profile"
            target="_blank"
          >
            <Button aria-label="linkedin profile">
              <Icon name="ri:linkedin-box-fill" />
              <span class="sr-only" data-umami-event="linkedin button"
                >Linkedin Profile</span
              >
            </Button>
          </a>
          <a href={LINKS.dribble} aria-label="dribble profile" target="_blank">
            <Button aria-label="dribble profile">
              <Icon name="ri:dribbble-fill" />
              <span class="sr-only" data-umami-event="Dribble button"
                >Dribble Profile</span
              >
            </Button>
          </a>
          <Tooltip client:visible>
            <Button aria-label="easter egg btn">
              <Icon name="ri:emotion-laugh-line" />
              <span class="sr-only" data-umami-event="Easter egg button"
                >Easter egg button</span
              >
            </Button>
          </Tooltip>
        </div>
        <Button aria-label="book a call" data-cal-link="ladvace">
          <span
            data-umami-event="Book a call"
            data-cal-link="ladvace"
            class="font-bold whitespace-nowrap">Book a call</span
          >
        </Button>
      </div>
    </div>
    <Image
      id="memoji-avatar"
      quality="max"
      src={MemojiAvatarDefault}
      data-theme-default={MemojiAvatarDefault.src}
      data-theme-yellow-theme={MemojiAvatarYellow.src}
      data-theme-blue-theme={MemojiAvatarBlue.src}
      data-theme-green-theme={MemojiAvatarGreen.src}
      data-theme-purple-theme={MemojiAvatarPurple.src}
      class="w-auto max-h-[300px] select-none absolute right-[-110px] bottom-[-20px] z-[-1] opacity-50 md:opacity-100 md:relative md:right-auto md:bottom-auto md:z-auto pointer-events-none"
      alt="memoji of gianmarco"
      loading="eager"
    />
  </div>
</Card>

<script>
  import { animate } from "motion";

  function updateMemojiImage() {
    const avatarImg = document.getElementById(
      "memoji-avatar"
    ) as HTMLImageElement;
    if (!avatarImg) return;

    const theme = localStorage.getItem("theme") || "default";
    const themeClass = theme === "default" ? "default" : theme;
    const imageSrc =
      avatarImg.getAttribute(`data-theme-${themeClass}`) ||
      avatarImg.getAttribute("data-theme-default");

    if (imageSrc && avatarImg.src !== imageSrc) {
      avatarImg.src = imageSrc;
      if (avatarImg.srcset) {
        avatarImg.srcset = "";
      }
    }
  }

  function initLevitatingAnimation() {
    const avatarImg = document.getElementById("memoji-avatar") as HTMLElement;
    if (!avatarImg) return;

    animate(
      avatarImg,
      { y: [-10, 10, -10] },
      {
        duration: 3,
        repeat: Infinity,
        ease: "easeInOut",
      }
    );
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      updateMemojiImage();
      initLevitatingAnimation();
    });
  } else {
    updateMemojiImage();
    initLevitatingAnimation();
  }

  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (
        mutation.type === "attributes" &&
        mutation.attributeName === "class"
      ) {
        updateMemojiImage();
      }
    });
  });

  if (document.body) {
    observer.observe(document.body, {
      attributes: true,
      attributeFilter: ["class"],
    });
  } else {
    document.addEventListener("DOMContentLoaded", () => {
      observer.observe(document.body, {
        attributes: true,
        attributeFilter: ["class"],
      });
      updateMemojiImage();
    });
  }

  document.addEventListener("themechange", updateMemojiImage);
</script>
